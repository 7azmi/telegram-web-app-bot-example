<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Welcome</title>
    <!-- Link to our new CSS files -->
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="styles.css">
    <!-- The core Telegram Web App script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div class="container">
    <h1>Welcome, <span id="user-name">Guest</span>!</h1>
    <p>Please select your language.</p>

    <div class="language-selector">
        <!-- Language codes (en, es, de) are used in IDs for easy JS selection -->
        <button class="lang-btn" id="lang-en">English</button>
        <button class="lang-btn" id="lang-es">Espa√±ol</button>
        <button class="lang-btn" id="lang-de">Deutsch</button>
    </div>

    <div class="user-data">
        <h2>Developer Info (Placeholders)</h2>
        <p>User ID: <code id="user-id-placeholder">Not available</code></p>
        <p>First Name: <code id="user-fname-placeholder">Not available</code></p>
        <p>Language Code: <code id="user-lang-placeholder">Not available</code></p>
    </div>
</div>

<script>
    // Wait for the DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;

        // --- 1. Basic Setup and Initialization ---
        tg.ready(); // Inform Telegram the web app is ready
        tg.expand(); // Expand the web app to full height

        // --- 2. Get User Data and Populate Placeholders ---
        const user = tg.initDataUnsafe?.user;

        if (user) {
            // Populate the welcome message and developer info
            document.getElementById('user-name').textContent = user.first_name || 'User';
            document.getElementById('user-id-placeholder').textContent = user.id;
            document.getElementById('user-fname-placeholder').textContent = user.first_name;
            document.getElementById('user-lang-placeholder').textContent = user.language_code;

            // Automatically select the language based on user's Telegram settings
            const userLang = user.language_code.split('-')[0]; // Use 'en' from 'en-US'
            const preselectedButton = document.getElementById(`lang-${userLang}`);
            if (preselectedButton) {
                preselectedButton.classList.add('active');
            }
        }

        // --- 3. Handle Language Selection ---
        const langButtons = document.querySelectorAll('.lang-btn');
        langButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                langButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to the clicked button
                button.classList.add('active');
                // Enable and update the main button
                tg.MainButton.setText(`Confirm ${button.textContent}`);
                tg.MainButton.show();
            });
        });

        // --- 4. Configure and Handle Main Button Click ---
        tg.MainButton.onClick(() => {
            const activeButton = document.querySelector('.lang-btn.active');
            if (activeButton) {
                const selectedLang = activeButton.id.replace('lang-', ''); // e.g., 'en'

                // Create a data object to send back to your bot
                const dataToSend = {
                    userId: user ? user.id : null,
                    selectedLanguage: selectedLang
                };

                // Send the data to the bot
                tg.sendData(JSON.stringify(dataToSend));

                // Optionally, close the web app after sending data
                tg.close();
            }
        });

        // Show main button only if a language is already pre-selected
        if (document.querySelector('.lang-btn.active')) {
            const activeButton = document.querySelector('.lang-btn.active');
            tg.MainButton.setText(`Confirm ${activeButton.textContent}`);
            tg.MainButton.show();
        }
    });
</script>
</body>
</html>